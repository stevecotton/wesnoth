# wmllint: no translatables

# The [unit] tag can recall units if a unit with that id already exists
# on the recall list. Some edge cases were unclear, so this test finds
# out what they do.
#
# This is a test where any failure should probably be fixed by changing the
# test to match changes in the engine. Having the test will be useful for
# reference to find out when the engine behavior changed.

# Test [unit] within [event]
{GENERIC_UNIT_TEST "recall_by_unit_tag" (
    [event]
        name = start

        # Create a unit on the recall list, as tested in the "units_offmap_goto_recall" test
        [unit]
            x = -10
            y = -10
            type = Orcish Grunt
            side = 1
            id = Charlie
            canrecruit = no
        [/unit]

        # Check assumptions used in the later assert of "there's no copies of the unit on the recall list"
        {ASSERT (
            [have_unit]
                x = recall
                y = recall
                search_recall_list = yes
            [/have_unit]
        )}

        # A no-op - this doesn't change the x or y coordinate, so Charlie stays off-map
        [unit]
            id = Charlie
        [/unit]
        {ASSERT (
            [not]
                [have_unit]
                    id = Charlie
                    search_recall_list = no
                [/have_unit]
            [/not]
        )}

        # Move Charlie on-map
        [unit]
            x = 1
            y = 1
            id = Charlie
        [/unit]

        {ASSERT (
            [have_unit]
                x = 1
                y = 1
                type = Orcish Grunt
                id = Charlie
                canrecruit = no
                side = 1
                search_recall_list = no
            [/have_unit]
        )}

        # Check that there's no copies of the unit on the recall list
        {ASSERT (
            [not]
                [have_unit]
                    x = recall
                    y = recall
                    search_recall_list = yes
                [/have_unit]
            [/not]
        )}

        {SUCCEED}
    [/event]
)}

# Test [unit] within [side]. This needs the Charlie to be on the recall list at
# the start of the scenario, so it requires two scenarios.
{GENERIC_UNIT_TEST "recall_by_side_unit_part_one" (
    [event]
        name = start

        [unit]
            x = -10
            y = -10
            # \todo this should make part 2 fail, Charlie is expected to be a Grunt
            type = Orcish Archer
            side = 1
            id = Charlie
            canrecruit = no
        [/unit]

        [endlevel]
            result = victory
            next_scenario = "recall_by_side_unit_part_two"
        [/endlevel]
    [/event]

    [event]
        name = turn 1
        {FAIL}
    [/event]
)}
[test]
    name = "Unit Test " + "recall_by_side_unit_part_two"
    map_file=test/maps/generic_unit_test.map
    turns = -1
    id = "recall_by_side_unit_part_two"
    is_unit_test = yes

    {DAWN}

    [side]
        side=1
        controller=human
        [leader]
            name = "Alice"
            type = Elvish Archer
            id=alice
        [/leader]

        # Move Charlie on-map
        [unit]
            x = 1
            y = 1
            id = Charlie
        [/unit]
    [/side]
    [side]
        side=2
        controller=human
        [leader]
            name = "Bob"
            type = Orcish Grunt
            id=bob
        [/leader]
    [/side]

    [event]
        name = start
        {ASSERT (
            [have_unit]
                x = 1
                y = 1
                type = Orcish Grunt
                id = Charlie
                canrecruit = no
                side = 1
                search_recall_list = no
            [/have_unit]
        )}

        # Check that there's no copies of the unit on the recall list
        {ASSERT (
            [not]
                [have_unit]
                    x = recall
                    y = recall
                    search_recall_list = yes
                [/have_unit]
            [/not]
        )}
        {SUCCEED}
    [/event]
[/test]
