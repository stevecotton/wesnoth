# wmllint: no translatables

[units]
    [resistance_defaults]
        id="special_res_for_test"
        default="30"
        orcishfoot="50"
    [/resistance_defaults]
    [resistance_defaults]
        id="copy_of_arcane"
        default="(arcane)"
    [/resistance_defaults]
    [resistance_defaults]
        id="copy_of_impact"
        default="(impact)"
    [/resistance_defaults]

    [terrain_defaults]
        id="special_terrain_for_test"
        [movement_costs]
            default="(swamp_water + 1)"
            orcishfoot="(vision_costs.swamp_water * 2)"
        [/movement_costs]
    [/terrain_defaults]
    [terrain_defaults]
        id="special_terrain_for_test"
        [defense]
            default="(20 + 7 * movement_costs.special_terrain_for_test)"
        [/defense]
# The next tag doesn't override the movement costs, so doesn't add a default= attribute
#ifndef SCHEMA_SHOULD_SKIP_THIS
        [vision_costs]
            # The next line is 100 + 3 + 70 + 1
            orcishfoot="(resistance.arcane + swamp_water + defense.swamp_water + jamming_costs.flat)"
        [/vision_costs]
#endif
    [/terrain_defaults]
[/units]

{GENERIC_UNIT_TEST "test_resistances" (
    [event]
        name = start

        [store_unit]
            [filter]
                id=alice
            [/filter]
            variable=alice
        [/store_unit]

        # Elvish archers have a slight malus against arcane
        {ASSERT {VARIABLE_CONDITIONAL alice.resistance.arcane equals 110}}
        {ASSERT {VARIABLE_CONDITIONAL alice.resistance.impact equals 100}}
        {ASSERT {VARIABLE_CONDITIONAL alice.resistance.special_res_for_test equals 30}}
        {ASSERT {VARIABLE_CONDITIONAL alice.resistance.copy_of_arcane equals 110}}
        {ASSERT {VARIABLE_CONDITIONAL alice.resistance.copy_of_impact equals 100}}
        {ASSERT {VARIABLE_CONDITIONAL alice.resistance.length equals 1}}
        {ASSERT {VARIABLE_CONDITIONAL alice.movement_costs.hills equals 2}}
        # Alice's movetype gets the default of movement_costs.swamp_water + 1
        {ASSERT {VARIABLE_CONDITIONAL alice.movement_costs.special_terrain_for_test equals 3}}
        {ASSERT {VARIABLE_CONDITIONAL alice.defense.special_terrain_for_test equals 41}}

        [store_unit]
            [filter]
                id=bob
            [/filter]
            variable=bob
        [/store_unit]

        {ASSERT {VARIABLE_CONDITIONAL bob.resistance.arcane equals 100}}
        {ASSERT {VARIABLE_CONDITIONAL bob.resistance.impact equals 100}}
        {ASSERT {VARIABLE_CONDITIONAL bob.resistance.special_res_for_test equals 50}}
        {ASSERT {VARIABLE_CONDITIONAL bob.movement_costs.hills equals 1}}
        # Bob's orcishfoot movetype uses the cost movement_costs.swamp_water * 2
        {ASSERT {VARIABLE_CONDITIONAL bob.movement_costs.special_terrain_for_test equals 6}}
        {ASSERT {VARIABLE_CONDITIONAL bob.defense.special_terrain_for_test equals 62}}
        {ASSERT {VARIABLE_CONDITIONAL bob.vision_costs.special_terrain_for_test equals 174}}

        # Check that there are exactly 6 + 3 resistance types, including
        # those added by the [resistance_defaults] tags.
        {ASSERT {VARIABLE_CONDITIONAL bob.resistance.length equals 1}}
        {VARIABLE key_count -1}
        [lua]
            code = <<
                local key_count = 0
                for k,v in pairs(wml.variables["bob.resistance[0]"]) do
                    key_count = key_count + 1
                end
                wml.variables["key_count"] = key_count
                >>
        [/lua]
        {ASSERT {VARIABLE_CONDITIONAL key_count equals 9}}

        {SUCCEED}
    [/event]
)}
