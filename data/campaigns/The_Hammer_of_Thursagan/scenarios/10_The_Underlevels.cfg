#textdomain wesnoth-thot

[scenario]
    id=10_The_Underlevels
    name= _ "The Underlevels"
    map_file=10_The_Underlevels.map
    turns=80
    next_scenario=11_Epilogue
    victory_when_enemies_defeated=yes

    {UNDERGROUND}

    {SCENARIO_MUSIC silence.ogg}

    ###########################################################################
    #                                  DEFINE SIDES
    ###########################################################################
    {PLAYER_SIDE SHROUD=yes GOLD=120}

#define RECRUITS_MASKED_DWARVES
    recruit="Dwarvish Masked Fighter, Dwarvish Masked Steelclad, Dwarvish Masked Thunderer, Dwarvish Masked Thunderguard, Dwarvish Masked Berserker"
#enddef

#define MASKED_DWARF TYPE X Y
    [unit]
        type={TYPE}
        x={X}
        y={Y}
        [modifications]
            {TRAIT_LOYAL}
        [/modifications]
        random_traits=yes
        name= _ "Masked Dwarf"
        ai_special=guardian
    [/unit]
#enddef

    [side]
        side=2
        controller=ai
        recruit= # Will change when the side is activated
        gold={ON_DIFFICULTY4 0 100 200 300}
        # 7 villages, no upkeep (initial guards are all loyal)
        # The longer you wait to confront Karrag, the more gold he will have had time to accumulate
        income={ON_DIFFICULTY4 -2 5 12 19}
        team_name=evil
        user_team_name= _ "Masked Dwarves"
        {FLAG_VARIANT knalgan}

        # wmllint: recognize Karrag
        {CHARACTER_STATS_KARRAG}

        color=black
        facing=nw

        {MASKED_DWARF ({ON_DIFFICULTY4 "Dwarvish Masked Guardsman" "Dwarvish Masked Guardsman"    "Dwarvish Masked Guardsman"   "Dwarvish Masked Stalwart"   }) 48 20} {ZONE_GUARDIAN 48 20 x,y,radius=51,19,4}
        {MASKED_DWARF ({ON_DIFFICULTY4 "Dwarvish Masked Guardsman" "Dwarvish Masked Guardsman"    "Dwarvish Masked Guardsman"   "Dwarvish Masked Stalwart"   }) 48 24} {ZONE_GUARDIAN 48 24 x,y,radius=51,26,4}

#ifndef EASY
        {MASKED_DWARF ({ON_DIFFICULTY4 "n/a"                       "Dwarvish Masked Steelclad"    "Dwarvish Masked Steelclad"   "Dwarvish Masked Steelclad"  }) 51 19} {ZONE_GUARDIAN 51 19 x,y,radius=55,17,5}
        {MASKED_DWARF ({ON_DIFFICULTY4 "n/a"                       "Dwarvish Masked Fighter"      "Dwarvish Masked Fighter"     "Dwarvish Masked Steelclad"  }) 52 18} {ZONE_GUARDIAN 52 18 x,y,radius=55,17,5}
#endif
        {MASKED_DWARF ({ON_DIFFICULTY4 "Dwarvish Masked Guardsman" "Dwarvish Masked Guardsman"    "Dwarvish Masked Stalwart"    "Dwarvish Masked Sentinel"   }) 53 20} {ZONE_GUARDIAN 53 20 x,y,radius=55,17,5}
        {MASKED_DWARF ({ON_DIFFICULTY4 "Dwarvish Masked Thunderer" "Dwarvish Masked Thunderguard" "Dwarvish Masked Dragonguard" "Dwarvish Masked Dragonguard"}) 54 21} {ZONE_GUARDIAN 54 21 x,y,radius=57,20,4}
        {MASKED_DWARF ({ON_DIFFICULTY4 "Dwarvish Masked Thunderer" "Dwarvish Masked Thunderguard" "Dwarvish Masked Dragonguard" "Dwarvish Masked Dragonguard"}) 54 23} {ZONE_GUARDIAN 54 23 x,y,radius=57,25,4}
        {MASKED_DWARF ({ON_DIFFICULTY4 "Dwarvish Masked Guardsman" "Dwarvish Masked Guardsman"    "Dwarvish Masked Stalwart"    "Dwarvish Masked Sentinel"   }) 53 25} {ZONE_GUARDIAN 53 25 x,y,radius=55,28,5}
#ifndef EASY
        {MASKED_DWARF ({ON_DIFFICULTY4 "n/a"                       "Dwarvish Masked Fighter"      "Dwarvish Masked Fighter"     "Dwarvish Masked Steelclad"  }) 52 26} {ZONE_GUARDIAN 52 26 x,y,radius=55,28,5}
        {MASKED_DWARF ({ON_DIFFICULTY4 "n/a"                       "Dwarvish Masked Steelclad"    "Dwarvish Masked Steelclad"   "Dwarvish Masked Steelclad"  }) 51 26} {ZONE_GUARDIAN 51 26 x,y,radius=55,28,5}
#endif

        {LOYAL_UNIT 2 ({ON_DIFFICULTY4 "Skeleton"        "Skeleton"     "Revenant"     "Draug"   }) 56 18} {GUARDIAN}
        {LOYAL_UNIT 2 ({ON_DIFFICULTY4 "Skeleton Archer" "Bone Shooter" "Bone Shooter" "Banebow" }) 56 19} {GUARDIAN}
        {LOYAL_UNIT 2 ({ON_DIFFICULTY4 "Skeleton"        "Skeleton"     "Skeleton"     "Revenant"}) 57 20} {GUARDIAN}
        {LOYAL_UNIT 2 ({ON_DIFFICULTY4 "Skeleton"        "Skeleton"     "Skeleton"     "Revenant"}) 57 25} {GUARDIAN}
        {LOYAL_UNIT 2 ({ON_DIFFICULTY4 "Skeleton Archer" "Bone Shooter" "Bone Shooter" "Banebow" }) 56 25} {GUARDIAN}
        {LOYAL_UNIT 2 ({ON_DIFFICULTY4 "Skeleton"        "Skeleton"     "Revenant"     "Draug"   }) 56 26} {GUARDIAN}
    [/side]
    {SILENTLY_LIMIT_LEADER_MOVES 2 1}

    [side]
        side=3
        controller=ai
        {RECRUITS_MASKED_DWARVES}
        gold=  {ON_DIFFICULTY4 0 25 50 75}
        income={ON_DIFFICULTY4 -2 3 8 13} # starts with 8 villages
        team_name=evil
        user_team_name= _ "Masked Dwarves"
        {FLAG_VARIANT knalgan}

        type=Dwarvish Masked Lord
        id=Dufon
        name= _ "Masked Dwarf"
        profile=portraits/maskeddwarf4.webp~RIGHT()
        canrecruit=yes
        facing=nw

        {MASKED_DWARF ({ON_DIFFICULTY4 "Dwarvish Masked Fighter"   "Dwarvish Masked Fighter"   "Dwarvish Masked Steelclad"    "Dwarvish Masked Steelclad"  }) 23 20}
        {MASKED_DWARF ({ON_DIFFICULTY4 "Dwarvish Masked Fighter"   "Dwarvish Masked Fighter"   "Dwarvish Masked Steelclad"    "Dwarvish Masked Steelclad"  }) 28 26}
        {MASKED_DWARF (Dwarvish Masked Thunderer) 24 19}
        {MASKED_DWARF (Dwarvish Masked Thunderer) 24 20}
        {MASKED_DWARF (Dwarvish Masked Thunderer) 27 26}
        {MASKED_DWARF (Dwarvish Masked Thunderer) 28 25}

        [ai]
            # don't try to capture villages. Our role is to put up a brief fight, then get killed by the player
            # capturing villages would spread out our units, and if the player was slow to kill us our income might even get high enough to trap the player in their starting spawn
            village_value=0
            {NO_SCOUTS}
            recruitment_pattern=fighter,fighter,mixed fighter
            aggression=0.9
        [/ai]
    [/side]
    {SILENTLY_LIMIT_LEADER_MOVES 3 1}

    [side]
        side=4
        controller=ai
        {RECRUITS_MASKED_DWARVES}
        gold=  {ON_DIFFICULTY4 0 25 50 75}
        income={ON_DIFFICULTY4 -2 3 8 13} # starts with 3 villages
        team_name=evil
        user_team_name= _ "Masked Dwarves"
        {FLAG_VARIANT knalgan}

        type=Dwarvish Masked Lord
        id=Aragoth
        name= _ "Masked Dwarf"
        profile=portraits/maskeddwarf2.webp~RIGHT()
        canrecruit=yes
        facing=sw

        {MASKED_DWARF ({ON_DIFFICULTY4 "Dwarvish Masked Guardsman" "Dwarvish Masked Guardsman" "Dwarvish Masked Stalwart" "Dwarvish Masked Stalwart"}) 30 11} {ZONE_GUARDIAN 30 11 x,y,radius=31,10,2}
        {MASKED_DWARF ({ON_DIFFICULTY4 "Dwarvish Masked Guardsman" "Dwarvish Masked Guardsman" "Dwarvish Masked Stalwart" "Dwarvish Masked Stalwart"}) 33 12} {ZONE_GUARDIAN 33 12 x,y,radius=31,11,2}
    [/side]
    {SILENTLY_LIMIT_LEADER_MOVES 4 1}

    [side]
        side=5
        controller=ai
        color=blue # this defaults to black, which overlaps with Karrag
        {RECRUITS_MASKED_DWARVES}
        gold=  {ON_DIFFICULTY4 0 25 50 75}
        income={ON_DIFFICULTY4 -2 3 8 13} # starts with 3 villages
        team_name=evil
        user_team_name= _ "Masked Dwarves"
        {FLAG_VARIANT knalgan}

        type=Dwarvish Masked Lord
        id=Dranath
        name= _ "Masked Dwarf"
        profile=portraits/maskeddwarf3.webp~RIGHT()
        canrecruit=yes
        facing=nw

        {MASKED_DWARF ({ON_DIFFICULTY4 "Dwarvish Masked Guardsman" "Dwarvish Masked Guardsman" "Dwarvish Masked Stalwart" "Dwarvish Masked Stalwart"}) 26 32} {ZONE_GUARDIAN 26 32 x,y,radius=27,34,3}
        {MASKED_DWARF ({ON_DIFFICULTY4 "Dwarvish Masked Guardsman" "Dwarvish Masked Guardsman" "Dwarvish Masked Stalwart" "Dwarvish Masked Stalwart"}) 29 32} {ZONE_GUARDIAN 29 32 x,y,radius=29,33,2}
    [/side]
    {SILENTLY_LIMIT_LEADER_MOVES 5 1}

    [event]
        name=side 4 turn
        first_time_only=no
        {RESET_SIDE_AI 4,5 offensive 0.9 0.1}
        {AUTOENRAGE 4 0}
        {AUTOENRAGE 5 0}
        # starts with 2 guards
        {RETREAT_WHEN_WEAK 4 {ON_DIFFICULTY4 0 0-5 0-6 0-7} (
            {GOAL_LOCATION 4 x,y=36,6}
            {GOAL_LOCATION 4 x,y=37,7}
            {GOAL_LOCATION 3 x,y=36,5}
            {GOAL_LOCATION 3 x,y=38,6}
            {GOAL_LOCATION 2 x,y=33,7}
            {GOAL_LOCATION 1 x,y=34,6}
            {GOAL_LOCATION 1 x,y=33,6}
        )}
        # starts with 2 guards
        {RETREAT_WHEN_WEAK 5 {ON_DIFFICULTY4 0 0-5 0-6 0-7} (
            {GOAL_LOCATION 5 x,y=34,35}
            {GOAL_LOCATION 4 x,y=35,35}
            {GOAL_LOCATION 4 x,y=34,36}
            {GOAL_LOCATION 3 x,y=33,34}
            {GOAL_LOCATION 2 x,y=36,35}
            {GOAL_LOCATION 1 x,y=36,34}
            {GOAL_LOCATION 1 x,y=37,35}
        )}
    [/event]

    # Scenery
    {PLACE_IMAGE "scenery/rune2.png" 38 21}
    {PLACE_IMAGE "scenery/rune4.png" 38 23}
    {PLACE_IMAGE "scenery/rune2.png" 44 6}
    {PLACE_IMAGE "scenery/rune4.png" 42 37}

    {PLACE_IMAGE "items/bones.png" 19 5}
    {PLACE_IMAGE "items/bones.png" 25 5}

    # Starting villages
    {STARTING_VILLAGES 2 9}
    {STARTING_VILLAGES 3 8}
    {STARTING_VILLAGES 4 6}
    {STARTING_VILLAGES 5 6}

    [event]
        name=prestart
        # un-capture any captured villages in the player's initial area
        [capture_village]
            x,y=0-20,15-22
        [/capture_village]

        [objectives]
            [objective]
                description= _ "Find Karrag"
                condition=win
            [/objective]
            [objective]
                description= _ "Death of Aiglondur or Angarthing"
                condition=lose
            [/objective]

            {TURNS_RUN_OUT}
            {IS_LAST_SCENARIO}
        [/objectives]

        {RECALL_XY Angarthing 5 18}
        {RECALL_XY Dulcatulos 4 19}
        {MODIFY_UNIT side=1 facing se}
    [/event]

    [event]
        name=unit placed
        first_time_only=no
        [filter]
            side=1
        [/filter]

        [object]
            silent=yes
            [filter]
                x,y=$x1,$y1
            [/filter]
            [effect]
                apply_to=vision_costs
                replace=yes
                [vision_costs]
                    impassable=3
                [/vision_costs]
            [/effect]
        [/object]
    [/event]

    [event]
        name=start

        {DELAY 500}
        [if]
            [have_unit]
                id=Dulcatulos
            [/have_unit]
            [then]
                [message]
                    speaker=Angarthing
                    message= _ "This place reeks of death."
                [/message]
                [message]
                    speaker=Dulcatulos
                    message= _ "It has been... so many years since I’ve been down here. Only Karrag and his personal followers — the masked ones — used this level. I can't believe I never wondered about that before."
                [/message]
                [message]
                    speaker=Angarthing
                    # wmllint: local spelling glamours
                    message= _ "It is Karrag’s doing—his will, and his dark magic. I think he has been casting glamours on all of you ever since he passed over."
                [/message]
            [/then]
            [else]
                [message]
                    speaker=Angarthing
                    message= _ "Dulcatulos fought with us to the death. How did he not wonder about Karrag before?"
                [/message]
                [message]
                    speaker=Angarthing
                    # wmllint: local spelling glamours
                    message= _ "It is Karrag’s doing—his will, and his dark magic. I think he has been casting glamours on all of you ever since he passed over."
                [/message]
            [/else]
        [/if]

        [message]
            speaker=Aiglondur
            message= _ "Where <i>is</i> Karrag? We can’t have been more than seconds behind him."
        [/message]

        [message]
            speaker=Angarthing
            message= _ "Most likely he has cloaked himself, thinking to run ahead to gather his followers. He could be within a spear-cast of us now and we wouldn’t know it in this gloom."
        [/message]

        [sound]
            name=ambient/wardrums.ogg
        [/sound]

        [message]
            speaker=Dulcatulos
            message= _ "Those are war-drums!"
        [/message]

        [message]
            speaker=Aiglondur
            message= _ "Aye. Karrag, calling his troops to battle. Only the Dark Gods know what hellspawn the lich will summon. AXES UP!"
        [/message]

        {REPLACE_SCENARIO_MUSIC knalgan_theme.ogg}
        {APPEND_MUSIC           siege_of_laurelmor.ogg}
        {APPEND_MUSIC           underground.ogg}
        {APPEND_MUSIC           the_dangerous_symphony.ogg}
        {APPEND_MUSIC           the_deep_path.ogg}
    [/event]

    ##################################### Hidden events #####################################

    # Small unit hitpoint bonuses
    [event]
        name=moveto
        first_time_only=yes
        [filter]
            side=1
            x,y=19,5
        [/filter]

        [message]
            speaker=unit
            message= _ "Someone died here."
        [/message]

        # Secret easter egg bonus
        # Give a unit 3 extra hp

        [object]
            [filter]
                x,y=$x1,$y1
            [/filter]
            duration=forever
            silent=yes
            [effect]
                apply_to=hitpoints
                increase_total=3
                increase=3
            [/effect]
        [/object]
    [/event]
    [event]
        name=moveto
        first_time_only=yes
        [filter]
            side=1
            x,y=25,5
        [/filter]

        [message]
            speaker=unit
            message= _ "Poor guy didn’t make it."
        [/message]

        # Secret easter egg bonus
        # Give a unit 3 extra hp

        [object]
            [filter]
                x,y=$x1,$y1
            [/filter]
            duration=forever
            silent=yes
            [effect]
                apply_to=hitpoints
                increase_total=3
                increase=3
            [/effect]
        [/object]
    [/event]

    # Gold pickups
    # gold is a nice one-time reward for exploration
    # without affecting long-term AI or player income
#define GOLD_PICKUP X Y AMOUNT MESSAGE
    {PLACE_IMAGE "items/chest.png" {X} {Y}}
    [event]
        name=moveto
        [filter]
            side=1
            x,y={X},{Y}
        [/filter]
        [message]
            speaker=unit
            message={MESSAGE}
        [/message]
        [sound]
            name=gold.ogg
        [/sound]
        [gold]
            side=1
            amount={AMOUNT}
        [/gold]
        {REMOVE_IMAGE {X} {Y}}
        {PLACE_IMAGE "items/chest-open.png" {X} {Y}}
    [/event]
#enddef
    {GOLD_PICKUP 12 28   50 _"This chest contains 50 gold pieces."}
    {GOLD_PICKUP 18 10   50 _"This chest contains 50 gold pieces."}
    {GOLD_PICKUP 42 30  150 _"There’s 150 gold in this chest!"}
    {GOLD_PICKUP 48 13  200 _"There’s 200 gold in this chest!"}

    #########################################################################################
    ################################## Gate opening events ##################################
    [event]
        name=moveto
        first_time_only=yes
        [filter]
            side=1
            x=16,17
            y=18,18
        [/filter]

        [if]
            [variable]
                name=unit.id
                equals=Aiglondur
            [/variable]
            [or]
                [variable]
                    name=unit.id
                    equals=Angarthing
                [/variable]
            [/or]
            [then]
                [message]
                    speaker=unit
                    message= _ "The gates are locked. I will have to break them open by force!"
                [/message]
            [/then]
            [else]
                [message]
                    speaker=unit
                    message= _ "The gates are locked!"
                [/message]

                [message]
                    speaker=Aiglondur
                    message= _ "Force them open!"
                [/message]

                [message]
                    speaker=unit
                    message= _ "Yes, sir!"
                [/message]
            [/else]
        [/if]

        [delay]
            time=1000
        [/delay]

        [sound]
            name=mace.ogg
        [/sound]

        [delay]
            time=100
        [/delay]

        [terrain]
            x=18,17
            y=18,19
            terrain=Ur^Pr/o
        [/terrain]
        [redraw]
            clear_shroud=yes
            side=1
        [/redraw]

        [delay]
            time=1000
        [/delay]

        [message]
            speaker=Angarthing
            message= _ "Let us proceed onward."
        [/message]
    [/event]

    # villages, gates, and runes are positioned so you can easily teleport away from the central area to heal at a northern/southern village
    [event]
        name=moveto
        first_time_only=yes
        [filter]
            side=1
            x,y=40-41,5
        [/filter]

        [if]
            [variable]
                name=unit.id
                equals=Aiglondur
            [/variable]
            [or]
                [variable]
                    name=unit.id
                    equals=Angarthing
                [/variable]
            [/or]
            [then]
                [message]
                    speaker=unit
                    message= _ "There’s something behind this door. I shall break it down!"
                [/message]
            [/then]
            [else]
                [message]
                    speaker=unit
                    message= _ "There’s something behind this door."
                [/message]

                [message]
                    speaker=Aiglondur
                    message= _ "Break it down!"
                [/message]
            [/else]
        [/if]

        [delay]
            time=1000
        [/delay]

        [sound]
            name=mace.ogg
        [/sound]

        [delay]
            time=100
        [/delay]

        [terrain]
            x,y=41,6
            terrain=Ur^Pr/o
        [/terrain]
        [redraw]
            clear_shroud=yes
            side=1
        [/redraw]
    [/event]

    # villages, gates, and runes are positioned so you can easily teleport away from the central area to heal at a northern/southern village
    [event]
        name=moveto
        first_time_only=yes
        [filter]
            side=1
            x,y=39,36
        [/filter]

        [message]
            speaker=unit
            message= _ "It looks like there is a rune behind this gate!"
        [/message]

        [delay]
            time=1000
        [/delay]

        [sound]
            name=mace.ogg
        [/sound]

        [delay]
            time=100
        [/delay]

        [terrain]
            x,y=40,36
            terrain=Ur^Pr/o
        [/terrain]
        [redraw]
            clear_shroud=yes
            side=1
        [/redraw]
    [/event]

    #########################################################################################
    ########################## Catching sight of enemy leaders ##############################
    [event]
        name=sighted
        [filter]
            side=3
        [/filter]
        [filter_second]
            side=1
        [/filter_second]

        # wait 1 turn to play this, otherwise it often overlaps with the initial gate-opening dialogue
        [event]
            name=side 3 turn
            delayed_variable_substitution=no
            [message]
                id=$unit.id
                message= _ "The dirtgrubber-friends have come! Slay them all!"
            [/message]

            [message]
                speaker=Aiglondur
                message= _ "You could not stop us before and you won’t be stopping us now!"
            [/message]
        [/event]
    [/event]

    [event]
        name=sighted
        [filter]
            id=Aragoth
        [/filter]
        [filter_second]
            side=1
        [/filter_second]

        [message]
            speaker=Aragoth
            message= _ "Your path forward ends here! Once the lord’s spell is complete, your souls will soon be chained to his will!"
        [/message]

        # Give side 4 some gold
        [gold]
            side=4
            amount={ON_DIFFICULTY4 0 10 20 30}
        [/gold]
    [/event]

    [event]
        name=sighted
        [filter]
            id=Dranath
        [/filter]
        [filter_second]
            side=1
        [/filter_second]

        [message]
            speaker=Dranath
            message= _ "The dirtgrubbers have come! Stop their advance!"
        [/message]

        # Give side 5 some gold
        [gold]
            side=5
            amount={ON_DIFFICULTY4 0 10 20 30}
        [/gold]
    [/event]
    #########################################################################################
    #################################### Rune events ########################################
    [event]
        name=explain_teleport_runes
        [message]
            speaker=unit
            message= _ "This must be a transport rune. Now that it is active, we can use to it to travel back and forth between here and the central gate."
        [/message]
        # reset moves, reselect the unit, and scroll to the center, so the player can see how [tunnel]s work
        [heal_unit]
            amount=0
            moves=full
            restore_statuses=no
        [/heal_unit]
        [select_unit]
            id=$unit.id
        [/select_unit]
        {SCROLL_TO 38 22}
        [event]
            name=explain_teleport_runes
            [message]
                speaker=unit
                message= _ "We have activated another transport rune."
            [/message]
        [/event]
    [/event]
    [event]
        name=moveto
        first_time_only=yes
        [filter]
            side=1
            x,y=44,6
        [/filter]

        [fire_event]
            name=explain_teleport_runes
            [primary_unit]
                id=$unit.id
            [/primary_unit]
        [/fire_event]

        [delay]
            time=1000
        [/delay]

        [sound]
            name=petrified.ogg
        [/sound]

        [delay]
            time=100
        [/delay]

        {PLACE_IMAGE "scenery/rune2-glow.png" 38 21}
        {PLACE_IMAGE "scenery/rune2-glow.png" 44 6}
        [tunnel]
            [filter]
            [/filter]
            [source]
                x,y=44,6
            [/source]
            [target]
                x,y=38,21
            [/target]
        [/tunnel]
    [/event]

    # Rune 2 activation
    [event]
        name=moveto
        [filter]
            side=1
            x,y=42,37
        [/filter]

        [fire_event]
            name=explain_teleport_runes
            [primary_unit]
                id=$unit.id
            [/primary_unit]
        [/fire_event]
        [delay]
            time=1000
        [/delay]
        [sound]
            name=petrified.ogg
        [/sound]
        [delay]
            time=100
        [/delay]
        {PLACE_IMAGE "scenery/rune4-glow.png" 38 23}
        {PLACE_IMAGE "scenery/rune4-glow.png" 42 47}
        [tunnel]
            [filter]
            [/filter]
            [source]
                x,y=42,37
            [/source]
            [target]
                x,y=38,23
            [/target]
        [/tunnel]
    [/event]

    # Explain to the player that the longer they wait, the stronger Karrag gets
    [event]
        name=turn 15
        id=explain_karrag_income

        [message]
            speaker=Aiglondur
            message= _ "Dark magic swirls in the air. Karrag grows stronger with each passing minute."
        [/message]
        [message]
            speaker=narrator
            image=wesnoth-icon.png
            message= _ "Karrag is not recruiting yet, so the longer it takes you to reach and confront him, the more gold he’ll have had time to stockpile. Open the Status Table (<i>Alt+S</i>) to check your opponents’ gold and income." + "

" + _"Of course, the longer you wait to confront Karrag, the more gold you’ll have time to stockpile too."
        [/message]
    [/event]

    # once Angarthing moves to the marked hex, open the gates and activate Karrag
    [event]
        name=moveto
        [filter]
            id=Angarthing
            x,y=38,22
        [/filter]
        [filter_condition]
            [not]
                [have_unit]
                    id=Dufon
                [/have_unit]
            [/not]
        [/filter_condition]

        {REMOVE_IMAGE 38 22}
        [remove_event]
            id=explain_karrag_income
        [/remove_event]

        [delay]
            time=1000
        [/delay]
        {MOVE_UNIT id=Angarthing 38 21}
        [delay]
            time=500
        [/delay]
        [animate_unit]
            [filter]
                id=Angarthing
            [/filter]
            flag=attack
            hits=yes
            [primary_attack]
                range=melee
            [/primary_attack]
            [facing]
                x,y=39,21
            [/facing]
        [/animate_unit]

        [delay]
            time=500
        [/delay]
        {MOVE_UNIT id=Angarthing 38 23}
        [delay]
            time=500
        [/delay]
        [animate_unit]
            [filter]
                id=Angarthing
            [/filter]
            flag=attack
            hits=yes
            [primary_attack]
                range=melee
            [/primary_attack]
            [facing]
                x,y=39,24
            [/facing]
        [/animate_unit]

        [delay]
            time=500
        [/delay]
        {MOVE_UNIT id=Angarthing 38 22}

        [delay]
            time=2000
        [/delay]

        [sound]
            name=rumble.ogg
        [/sound]
        {EARTHQUAKE ()}
        {EARTHQUAKE ()}

        [delay]
            time=2000
        [/delay]

        [sound]
            name=dragonstick.ogg
        [/sound]

        [terrain]
            x=39,40
            y=23,23
            terrain=Uu
        [/terrain]
        [terrain]
            x=40,41
            y=22,23
            terrain=Ur
        [/terrain]
        [terrain]
            x=39,40
            y=22,21
            terrain=Ur^Es
        [/terrain]
        [terrain]
            x,y=41,22
            terrain=Uu^Emf
        [/terrain]
        [redraw][/redraw]

        [delay]
            time=500
        [/delay]

        [message]
            speaker=Angarthing
            message= _ "It is done."
        [/message]

        [message]
            speaker=Aiglondur
            message= _ "The lich surely awaits us within. We must be on guard."
        [/message]

        # now that we've met Karrag, let him recruit
        # these high-level units are a great opportunity to use the Inspire ability
        # and Wraiths help keep Thunderers relevant
        [modify_side]
            side=2
            recruit=Necrophage,Revenant,Bone Shooter,Wraith
        [/modify_side]
#ifndef EASY
        [allow_recruit]
            side=2
            type=Ghast,Draug,Banebow
        [/allow_recruit]
        {LIMIT_RECRUITS 2 Ghast   ({ON_DIFFICULTY4 0 1 1 2})}
        {LIMIT_RECRUITS 2 Draug   ({ON_DIFFICULTY4 0 1 1 1})}
        {LIMIT_RECRUITS 2 Banebow ({ON_DIFFICULTY4 0 0 1 1})}
#endif

        [objectives]
            [objective]
                description= _ "Defeat Karrag"
                condition=win
            [/objective]
            [objective]
                description= _ "Death of Aiglondur or Angarthing"
                condition=lose
            [/objective]
            {IS_LAST_SCENARIO}
        [/objectives]
    [/event]

    #########################################################################################
    ################################ Karrag's speeches ######################################
    [event]
        name=sighted
        [filter]
            side=2
        [/filter]
        [filter_second]
            side=1
        [/filter_second]

        [message]
            speaker=unit
            message= _ "My lord, the dirtgrubbers have entered our sanctuary!"
        [/message]

        [message]
            speaker=Karrag
            message={KARRAG_BLUE _"Excellent! Their blood will provide plenty of fuel for my ritual!"}
        [/message]
    [/event]

    [event]
        name=sighted
        [filter]
            id=Karrag
        [/filter]
        [filter_second]
            side=1
        [/filter_second]

        [message]
            speaker=Karrag
            message={KARRAG_BLUE _"So, the usurpers have arrived at last."}
        [/message]

        [message]
            speaker=Aiglondur
            message= _ "We are not the usurpers but the liberators of Kal Kartha! We are here to free our kin from your dark sorcery!"
        [/message]

        [message]
            speaker=Karrag
            message={KARRAG_BLUE _"You insolent fool! It is I who have led Kal Kartha to glory and I who have cleansed the lands of the true people from all unworthy scum! Kal Kartha owes me everything!"}
        [/message]

        [message]
            speaker=Angarthing
            message= _ "No! You are the one who owes our brethren their freedom! You have ensnared their minds with your foul magic and now we are here to put an end to your tyrannical rule!"
        [/message]

        [message]
            speaker=Karrag
            message={KARRAG_BLUE _"Any enemy of my rule is no better than the filthiest of dirtgrubbers. You no longer belong to the true people. You will become my slaves!"}
        [/message]

        [message]
            speaker=Aiglondur
            message= _ "Not if we stop you here. AXES UP!"
        [/message]

        # Give Karrag more gold
        # use [modify_side] instead of [gold] so that we bypass any negative gold due to upkeep
        [modify_side]
            side=2
            gold={ON_DIFFICULTY4 0 100 200 300}
        [/modify_side]
    [/event]

    [event]
        name=last breath
        [filter]
            id=Karrag
        [/filter]

        [message]
            speaker=Karrag
            message={KARRAG_BLUE _"No! No! No! Dirtgrubbers must die! The true people must rule all!"}
        [/message]

        [message]
            speaker=Aiglondur
            message= _ "The ‘true people’ speak through our axes. Die, foul lich."
        [/message]

        [message]
            speaker=Karrag
            message={KARRAG_BLUE _"Nooo! My power... it wanes..."}
        [/message]

        [kill]
            id=Karrag
            animate=yes
        [/kill]
        {FADE_MUSIC_OUT 500}
        {REPLACE_SCENARIO_MUSIC silence.ogg}
        {FADE_MUSIC_IN 0}

        [if]
            [have_unit]
                id=Dulcatulos
            [/have_unit]
            [then]
                [message]
                    speaker=Dulcatulos
                    message= _ "And your rule is at an end, Karrag, once the brave lord of Kal Kartha."
                [/message]
                [message]
                    speaker=Aiglondur
                    message= _ "Do not mourn his passing, Dulcatulos. The Karrag you knew died many years ago when his lust for power consumed him. It is now time to put the past behind and right the wrongs that have been wrought here."
                [/message]
            [/then]
            [else]
                [message]
                    speaker=Aiglondur
                    message= _ "And your rule is at an end, Karrag, once the brave lord of Kal Kartha. It is now time to put the past behind and right the wrongs that have been wrought here."
                [/message]
            [/else]
        [/if]

        [message]
            speaker=Angarthing
            message= _ "Aiglondur speaks the truth. The deed is done. Though the heart of the darkness is gone, there is still much to do. Much will have to be done to amend the desecration of the Hammer and the evil that has been done here."
        [/message]

        [message]
            speaker=Aiglondur
            message= _ "But first, we must bring this news to the rest of Kal Kartha. A new Lord must be chosen."
        [/message]

        [message]
            speaker=Angarthing
            message= _ "Aye, let us go."
        [/message]

        [endlevel]
            result=victory
            carryover_report=no
        [/endlevel]

#ifdef HARD
        [set_achievement]
            content_for=the_hammer_of_thursagan
            id="new_thursagan"
        [/set_achievement]
#endif
    [/event]
    #########################################################################################
    ######################################## Deaths #########################################
    [event]
        name=attack
        [filter_second]
            id=Dufon
        [/filter_second]

        [message]
            speaker=Dufon
            message= _ "You shall never pass through here! The doors I guard are sealed by the power of the Hammer itself."
        [/message]

        [message]
            speaker=unit
            message= _ "You won’t stop us!"
        [/message]

        [message]
            speaker=Dufon
            message= _ "Fools! Even should you defeat me, the master’s ritual will soon be complete and you shall all become his slaves!"
        [/message]
    [/event]
    [event]
        name=last breath
        [filter]
            id=Dufon
        [/filter]

        [message]
            speaker=Dufon
            message= _ "The master’s ritual... must not be... interrupted..."
        [/message]

        [event]
            name=die
            [remove_shroud]
                side=1
                x,y=38,22
                radius=2
            [/remove_shroud]
            {SCROLL_TO 38 22}

            [message]
                speaker=second_unit
                message= _ "It seems that the guard spoke the truth. The eastern way is shut fast! There are two curious runes on the ground."
            [/message]

            [message]
                speaker=Angarthing
                message= _ "The way is sealed by the ancient runelore of the Hammer. No amount of force can open these doors."
            [/message]

            [message]
                speaker=Ratheln
                message= _ "Most curious. I’ve never encountered magic of this sort before."
            [/message]

            [message]
                speaker=Aiglondur
                message= _ "You know something of runes, Angarthing. You have read Thursagan’s notebook."
            [/message]

            [message]
                speaker=Angarthing
                message= _ "Aye."
            [/message]

            [message]
                speaker=Aiglondur
                message= _ "Can you open the doors?"
            [/message]

            [message]
                speaker=Angarthing
                message= _ "Perhaps. We must be prepared for what lies beyond."
            [/message]

            {HIGHLIGHT_IMAGE 38 22 items/gohere.png ()}
            [objectives]
                [objective]
                    description= _ "Prepare to face Karrag"
                    condition=win
                [/objective]
                [objective]
                    description= _ "When you are ready, move Angarthing to the marked hex"
                    condition=win
                [/objective]
                [objective]
                    description= _ "Death of Aiglondur or Angarthing"
                    condition=lose
                [/objective]
                {TURNS_RUN_OUT}
                {IS_LAST_SCENARIO}
            [/objectives]
        [/event]
    [/event]

    [event]
        name=last breath
        [filter]
            id=Dranath
        [/filter]

        [message]
            speaker=Dranath
            message= _ "Imbeciles! Once the master’s dark rite is complete, I will return to slay you myself!"
        [/message]
    [/event]

    [event]
        name=last breath
        [filter]
            id=Aragoth
        [/filter]

        [message]
            speaker=Aragoth
            message= _ "The heathens... have slain me-"
        [/message]
    [/event]
    #########################################################################################
    ################################## Running out of time ##################################

    # these message still play even after Karrag is activated (and the turn limit is removed), but I think that's ok
    [event]
        name=turn 60

        [message]
            speaker=Aiglondur
            message= _ "The air is cold with the stench of death."
        [/message]

        [message]
            speaker=Angarthing
            message= _ "No doubt it is this ritual that the masked ones spoke of. We must hurry and stop Karrag!"
        [/message]
    [/event]

    [event]
        name=turn 70

        [harm_unit]
            [filter]
                id=Aiglondur
            [/filter]
            animate=yes
            amount=3
            kill=no
            slowed=yes
        [/harm_unit]

        [message]
            speaker=Aiglondur
            message= _ "I feel as if the life is being sapped out of my body!"
        [/message]

        [message]
            speaker=Angarthing
            message= _ "Karrag’s spell grows more powerful with every passing moment. If we do not defeat him now, we will all turn into his thralls!"
        [/message]
    [/event]

    [event]
        name=time over

        [message]
            speaker=Karrag
            message={KARRAG_BLUE _"HAHAHAHA! Yes, yes, YES! The rite of death is complete at last! Die, you filthy dirtgrubbers, die so that I may raise you again as my mindless slaves!"}
        [/message]

        [endlevel]
            result=defeat
        [/endlevel]
    [/event]
    #########################################################################################

    {HERODEATH_AIGLONDUR}
    {HERODEATH_ANGARTHING}
    {HERODEATH_RATHELN}
    {HERODEATH_DULCATULOS}
[/scenario]

#undef RECRUITS_MASKED_DWARVES
#undef MASKED_DWARF
